// src/database.js
const sqlite3 = require('sqlite3').verbose();
const { open } = require('sqlite');
const path = require('path');

let db;

async function initDatabase() {
  db = await open({
    filename: path.join(__dirname, '../data/stats.db'),
    driver: sqlite3.Database
  });

  // Create tables for monthly and overall stats
  await db.exec(`
    CREATE TABLE IF NOT EXISTS monthly_stats (
      user_id TEXT PRIMARY KEY,
      username TEXT,
      voice_time INTEGER DEFAULT 0,
      message_count INTEGER DEFAULT 0,
      lineage_time INTEGER DEFAULT 0,
      reaction_count INTEGER DEFAULT 0,
      apollo_events INTEGER DEFAULT 0,
      party_count INTEGER DEFAULT 0,
      cp_turnover INTEGER DEFAULT 0,
      aq_calls INTEGER DEFAULT 0,
      rental_count INTEGER DEFAULT 0,
      screenshot_count INTEGER DEFAULT 0
    );

    CREATE TABLE IF NOT EXISTS overall_stats (
      user_id TEXT PRIMARY KEY,
      username TEXT,
      voice_time INTEGER DEFAULT 0,
      message_count INTEGER DEFAULT 0,
      lineage_time INTEGER DEFAULT 0,
      reaction_count INTEGER DEFAULT 0,
      apollo_events INTEGER DEFAULT 0,
      party_count INTEGER DEFAULT 0,
      cp_turnover INTEGER DEFAULT 0,
      aq_calls INTEGER DEFAULT 0,
      rental_count INTEGER DEFAULT 0,
      screenshot_count INTEGER DEFAULT 0
    );

    CREATE TABLE IF NOT EXISTS voice_sessions (
      user_id TEXT,
      join_time INTEGER,
      is_active INTEGER DEFAULT 1
    );

    CREATE TABLE IF NOT EXISTS activity_sessions (
      user_id TEXT,
      start_time INTEGER,
      is_active INTEGER DEFAULT 1
    );

    CREATE TABLE IF NOT EXISTS config (
      key TEXT PRIMARY KEY,
      value TEXT
    );
  `);

  return db;
}

async function incrementStat(userId, username, statType, amount = 1) {
  const tables = ['monthly_stats', 'overall_stats'];
  
  for (const table of tables) {
    await db.run(
      `INSERT INTO ${table} (user_id, username, ${statType})
       VALUES (?, ?, ?)
       ON CONFLICT(user_id) DO UPDATE SET
       username = excluded.username,
       ${statType} = ${statType} + excluded.${statType}`,
      [userId, username, amount]
    );
  }
}

async function getTopStats(table = 'monthly_stats', limit = 10) {
  const stats = {
    voice_time: [],
    message_count: [],
    lineage_time: [],
    reaction_count: [],
    apollo_events: [],
    party_count: [],
    cp_turnover: [],
    aq_calls: [],
    rental_count: [],
    screenshot_count: []
  };

  for (const [key] of Object.entries(stats)) {
    stats[key] = await db.all(
      `SELECT user_id, username, ${key} as value
       FROM ${table}
       WHERE ${key} > 0
       ORDER BY ${key} DESC
       LIMIT ?`,
      [limit]
    );
  }

  return stats;
}

async function resetMonthlyStats() {
  await db.run('DELETE FROM monthly_stats');
  await db.run('DELETE FROM voice_sessions');
  await db.run('DELETE FROM activity_sessions');
  console.log('âœ… Monthly stats reset');
}

async function startVoiceSession(userId) {
  await db.run(
    'INSERT INTO voice_sessions (user_id, join_time) VALUES (?, ?)',
    [userId, Date.now()]
  );
}

async function endVoiceSession(userId, username) {
  const session = await db.get(
    'SELECT join_time FROM voice_sessions WHERE user_id = ? AND is_active = 1',
    [userId]
  );

  if (session) {
    const duration = Math.floor((Date.now() - session.join_time) / 1000);
    await incrementStat(userId, username, 'voice_time', duration);
    await db.run(
      'UPDATE voice_sessions SET is_active = 0 WHERE user_id = ? AND is_active = 1',
      [userId]
    );
  }
}

async function startActivitySession(userId) {
  const existing = await db.get(
    'SELECT * FROM activity_sessions WHERE user_id = ? AND is_active = 1',
    [userId]
  );

  if (!existing) {
    await db.run(
      'INSERT INTO activity_sessions (user_id, start_time) VALUES (?, ?)',
      [userId, Date.now()]
    );
  }
}

async function endActivitySession(userId, username) {
  const session = await db.get(
    'SELECT start_time FROM activity_sessions WHERE user_id = ? AND is_active = 1',
    [userId]
  );

  if (session) {
    const duration = Math.floor((Date.now() - session.start_time) / 1000);
    await incrementStat(userId, username, 'lineage_time', duration);
    await db.run(
      'UPDATE activity_sessions SET is_active = 0 WHERE user_id = ? AND is_active = 1',
      [userId]
    );
  }
}

async function getConfig(key) {
  const result = await db.get('SELECT value FROM config WHERE key = ?', [key]);
  return result ? result.value : null;
}

async function setConfig(key, value) {
  await db.run(
    'INSERT OR REPLACE INTO config (key, value) VALUES (?, ?)',
    [key, value]
  );
}

module.exports = {
  initDatabase,
  incrementStat,
  getTopStats,
  resetMonthlyStats,
  startVoiceSession,
  endVoiceSession,
  startActivitySession,
  endActivitySession,
  getConfig,
  setConfig
};

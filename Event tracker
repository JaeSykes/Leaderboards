// src/trackers/index.js
const { incrementStat, startVoiceSession, endVoiceSession, startActivitySession, endActivitySession } = require('../database');

const GUILD_ID = '1397286059406000249';
const SCREENSHOTS_CHANNEL = '1397653994889019434';

function startTracking(client) {
  // 1. Track voice channel time
  client.on('voiceStateUpdate', async (oldState, newState) => {
    if (oldState.guild.id !== GUILD_ID) return;

    const userId = newState.id;
    const username = newState.member.user.username;

    // User joined voice
    if (!oldState.channelId && newState.channelId) {
      await startVoiceSession(userId);
    }
    
    // User left voice
    if (oldState.channelId && !newState.channelId) {
      await endVoiceSession(userId, username);
    }
  });

  // 2. Track messages and AQ UP calls
  client.on('messageCreate', async (message) => {
    if (message.guild?.id !== GUILD_ID) return;
    if (message.author.bot) return;

    const userId = message.author.id;
    const username = message.author.username;

    // Count message
    await incrementStat(userId, username, 'message_count');

    // Count AQ UP calls (case insensitive)
    if (message.content.toUpperCase().includes('AQ UP')) {
      await incrementStat(userId, username, 'aq_calls');
    }

    // Count screenshots in screenshots-ally channel
    if (message.channelId === SCREENSHOTS_CHANNEL) {
      if (message.attachments.size > 0 || message.embeds.some(e => e.image || e.thumbnail)) {
        await incrementStat(userId, username, 'screenshot_count');
      }
    }

    // Parse bot embeds
    if (message.author.bot && message.embeds.length > 0) {
      await parseBotEmbeds(message);
    }
  });

  // 3. Track reactions received
  client.on('messageReactionAdd', async (reaction, user) => {
    if (reaction.message.guild?.id !== GUILD_ID) return;
    if (!reaction.message.author) return;
    if (reaction.message.author.bot) return;

    const messageAuthor = reaction.message.author;
    await incrementStat(messageAuthor.id, messageAuthor.username, 'reaction_count');
  });

  // 4. Track Lineage II activity
  client.on('presenceUpdate', async (oldPresence, newPresence) => {
    if (newPresence.guild?.id !== GUILD_ID) return;
    if (newPresence.user.bot) return;

    const userId = newPresence.userId;
    const username = newPresence.user.username;

    const oldActivity = oldPresence?.activities?.find(a => 
      a.name && a.name.toLowerCase().includes('lineage')
    );
    const newActivity = newPresence.activities?.find(a => 
      a.name && a.name.toLowerCase().includes('lineage')
    );

    // Started playing Lineage
    if (!oldActivity && newActivity) {
      await startActivitySession(userId);
    }
    
    // Stopped playing Lineage
    if (oldActivity && !newActivity) {
      await endActivitySession(userId, username);
    }
  });

  console.log('✅ All event trackers registered');
}

async function parseBotEmbeds(message) {
  const embed = message.embeds[0];
  if (!embed || !embed.description) return;

  // Apollo Bot - Event attendance
  if (message.author.username === 'Apollo' && embed.description.includes('✅ Accepted')) {
    const acceptedSection = embed.description.match(/✅ Accepted \((\d+)\)([\s\S]*?)(?=❌|$)/);
    if (acceptedSection) {
      const userMentions = acceptedSection[2].match(/<@!?(\d+)>/g) || [];
      for (const mention of userMentions) {
        const userId = mention.match(/\d+/)[0];
        try {
          const member = await message.guild.members.fetch(userId);
          await incrementStat(userId, member.user.username, 'apollo_events');
        } catch (err) {
          console.error(`Failed to fetch member ${userId}:`, err);
        }
      }
    }
  }

  // Party Jack - Party creator
  if (message.author.username === 'Party Jack' && embed.description.includes('Založatel:')) {
    const creatorMatch = embed.description.match(/Založatel:\s*<@!?(\d+)>/);
    if (creatorMatch) {
      const userId = creatorMatch[1];
      try {
        const member = await message.guild.members.fetch(userId);
        await incrementStat(userId, member.user.username, 'party_count');
      } catch (err) {
        console.error(`Failed to fetch member ${userId}:`, err);
      }
    }
  }

  // Navrátil (Accounting Bot) - CP Turnover
  if (message.author.username === 'Mišička z účtárny' && embed.title?.includes('Nová Transakce')) {
    const amountMatch = embed.description?.match(/Nový pohyb:\s*([-\d.,]+)\s*Adena/);
    if (amountMatch) {
      const amount = Math.abs(parseInt(amountMatch[1].replace(/[.,]/g, '')));
      
      // Try to find who made the transaction from description
      const userMatch = embed.description?.match(/Popis:\s*(.+)/);
      if (userMatch) {
        const description = userMatch[1];
        const mentionMatch = description.match(/<@!?(\d+)>/);
        if (mentionMatch) {
          const userId = mentionMatch[0].match(/\d+/)[0];
          try {
            const member = await message.guild.members.fetch(userId);
            await incrementStat(userId, member.user.username, 'cp_turnover', amount);
          } catch (err) {
            console.error(`Failed to fetch member ${userId}:`, err);
          }
        }
      }
    }
  }

  // Navrátil (Rental Bot) - Item rentals
  if (message.author.username === 'Navrátil' && embed.description?.includes('Má:')) {
    const ownerMatch = embed.description.match(/Má:\s*(.+)/);
    if (ownerMatch) {
      const ownerText = ownerMatch[1];
      const mentionMatch = ownerText.match(/<@!?(\d+)>/);
      if (mentionMatch) {
        const userId = mentionMatch[0].match(/\d+/)[0];
        try {
          const member = await message.guild.members.fetch(userId);
          await incrementStat(userId, member.user.username, 'rental_count');
        } catch (err) {
          console.error(`Failed to fetch member ${userId}:`, err);
        }
      }
    }
  }
}

module.exports = { startTracking };
